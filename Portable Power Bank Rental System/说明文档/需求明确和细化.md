**一、系统总体目标**

开发一个基于客户端/服务器 (C/S) 架构的桌面应用程序，允许普通用户注册、登录、租赁和归还移动电源，并允许管理员（由超级管理员创建和管理）管理普通用户账户和移动电源信息。系统需提供一个超级管理员账户，用于管理管理员账户。计费规则为不足一小时按一小时计算，每小时1.5元。

**二、角色与权限详细定义**

系统包含三种角色：超级管理员、管理员、普通用户。

1.  **超级管理员 (Super Administrator)**
    *   **账号来源：** 系统预设，唯一。不能通过系统注册，通常在系统初始化时硬编码或通过脚本直接写入数据库。
    *   **登录凭证：** 用户名、密码。
    *   **核心权限与功能：**
        *   **管理员账户管理：**
            *   **创建管理员账号：** 为新的管理员设置用户名和初始密码。
            *   **查看管理员列表：** 列出所有已创建的管理员账号信息（如用户名、创建时间等，但不应显示密码）。
            *   **修改管理员信息：** 重置管理员密码。
            *   **删除管理员账号：** 从系统中移除管理员账号。
        *   查看系统操作日志（特别是管理员操作日志）。
    *   **限制：**
        *   超级管理员账号唯一，不能被创建或删除（只能通过后台操作）。
        *   超级管理员不能执行普通管理员或普通用户的操作（如管理移动电源、租赁电源等）。

2.  **管理员 (Administrator)**
    *   **账号来源：** 由超级管理员创建。
    *   **登录凭证：** 用户名、密码。
    *   **核心权限与功能：**
        *   **普通用户账户管理：**
            *   **查看普通用户列表：** 列出所有已注册的普通用户信息（如用户名、注册时间、账户状态）。
            *   **修改普通用户信息：** （主要是）重置普通用户密码。
            *   **管理普通用户状态：** 禁用或启用普通用户账户（例如，用户违规操作后可禁用）。
            *   **删除普通用户账号：** 从系统中移除普通用户账号（需要考虑该用户是否有未完成的订单或欠费）。
        *   **移动电源管理：**
            *   **添加移动电源：** 录入新的移动电源信息（如：电源ID/序列号、型号、初始容量、当前电量百分比、初始状态设为“可用”）。
            *   **查看移动电源列表：** 列出所有移动电源及其详细信息（ID、型号、容量、当前电量、状态如“可用”、“租赁中”、“低电量”、“维护中”等）。
            *   **修改移动电源信息：** 更新移动电源的型号、描述等（ID一般不修改）。可以手动调整电量（模拟充电完成）或设置状态（如“维护中”、“下架”）。
            *   **删除移动电源：** 从系统中移除某个移动电源（需确保该电源未被租赁）。
        *   **订单管理（主要是查看）：**
            *   查看所有用户的租赁订单历史记录（用户、电源、起止时间、费用）。

3.  **普通用户 (User)**
    *   **账号来源：** 通过系统注册功能自由注册。
    *   **注册信息：** 仅需用户名和密码。
    *   **登录凭证：** 用户名、密码。
    *   **核心权限与功能：**
        *   **个人账户管理：**
            *   **注册：** 提供用户名和密码进行注册。系统需检查用户名唯一性。
            *   **登录/登出。**
            *   **修改个人密码。**
        *   **移动电源操作：**
            *   **浏览可用移动电源：** 查看当前状态为“可用”的移动电源列表及其信息（如ID、型号、当前电量）。
            *   **租赁移动电源：** 选择一个可用的移动电源进行租赁。租赁成功后，该电源状态变为“租赁中”，系统记录租赁开始时间。
            *   **归还移动电源：** 归还当前正在租赁的移动电源。归还后，系统记录归还时间，计算租赁时长和费用，并更新订单状态。电源状态根据电量可能变为“可用”或“低电量”，或由管理员后续操作变为“充电中”。
        *   **订单管理：**
            *   **查看个人历史订单：** 列出自己所有的租赁记录（包括进行中的和已完成的），显示租赁起止时间、时长、费用等。

**三、核心业务流程细化**

1.  **普通用户注册流程：**
    *   用户打开注册界面，输入用户名、密码、确认密码。
    *   系统校验：用户名不能为空，密码不能为空，两次输入的密码必须一致。
    *   系统检查用户名是否已在数据库中存在。
        *   若存在，提示“用户名已存在”。
        *   若不存在，将用户名和（哈希加盐处理后的）密码存入用户表，角色设为“普通用户”，账户状态设为“激活”。提示“注册成功”。

2.  **用户登录流程（适用于所有角色）：**
    *   用户打开登录界面，输入用户名、密码。
    *   系统校验：用户名和密码不能为空。
    *   系统根据用户名查询用户表。
        *   若用户不存在，提示“用户名或密码错误”。
        *   若用户存在，验证输入的密码与数据库中存储的（哈希）密码是否匹配。
            *   若不匹配，提示“用户名或密码错误”。
            *   若匹配，检查账户是否被禁用。
                *   若被禁用，提示“账户已被禁用，请联系管理员”。
                *   若未禁用，登录成功。根据用户角色，跳转到对应的主界面（超级管理员界面、管理员界面或普通用户界面）。
                *   更新该用户的 `last_login_time` 字段为当前系统时间。

3.  **超级管理员创建管理员账号流程：**
    *   超级管理员登录后，进入“管理员管理”界面。
    *   点击“创建管理员”按钮。
    *   输入新管理员的用户名和初始密码。
    *   系统校验：用户名和密码不能为空。
    *   系统检查用户名是否已在数据库中存在（确保管理员用户名也唯一）。
        *   若存在，提示“该管理员用户名已存在”。
        *   若不存在，将新管理员的用户名和（哈希加盐处理后的）初始密码存入用户表，角色设为“管理员”。提示“管理员创建成功”。

4.  **普通用户租赁移动电源流程：**
	- 普通用户登录后，进入“浏览可用电源”界面。
	- 系统显示所有状态为 `available` (可用) 且 `current_charge_percentage` > 20% (电量充足阈值为50%) 的移动电源列表。
	- 用户选择一个移动电源，点击“租赁”。
	- 系统检查该电源是否仍为 `available` 且电量充足。
	    - 若不是，提示“该电源已被租用、电量不足或不可用”。
	    - 若是，创建一条新的租赁订单记录：
	        - 包含用户ID、电源ID。
	        - 记录租赁开始时间 (`rental_start_time`) 为当前系统时间。
	        - 记录租赁开始时电源电量 (`rental_start_charge_percentage`)，从该电源当前电量获取。
	        - 订单状态 (`order_status`) 设为 `active` (进行中)。
	    - 更新该移动电源的：
	        - 状态 (`status`) 变为 `rented` (租赁中)。
	        - `total_rental_count` (累计租赁次数) 加 1。
	    - 提示“租赁成功”。

5.  **普通用户归还移动电源流程：**
    *   普通用户登录后，若有未归还的电源，界面上应有“归还电源”的选项。
    *   用户点击“归还电源”。
    *   系统查找该用户当前“进行中”的租赁订单。
    *   记录当前时间为“归还时间”。
    *   **计算费用：**
        *   计算租赁时长（分钟） = `rental_end_time` - `rental_start_time`。
        *   计算计费时长（小时） = `Math.ceil(租赁时长（分钟） / 60.0)` (向上取整，不足一小时按一小时)。
        *   计算费用 = 计费时长 * 1.5 元。
	- **更新被归还移动电源的电量和状态：**
	    - 消耗电量（百分比） = 租赁时长（分钟） * 1 (每分钟消耗1%)。
	    - 归还后剩余电量 = 订单中记录的 `rental_start_charge_percentage` - 消耗电量。
	    - 如果 归还后剩余电量 < 0，则 归还后剩余电量 = 0。
	    - 更新移动电源表中的 `current_charge_percentage` 为此“归还后剩余电量”。
	    - 根据“归还后剩余电量”更新移动电源状态 (`status`)：
	        - 如果 归还后剩余电量 > 20% (假设低电量阈值为20%)，则状态设为 `available` (可用)。
	        - 否则，状态设为 `low_battery` (低电量)。
	- 更新租赁订单记录：
	    - 填入 `rental_end_time`。
	    - 填入 `billed_hours` (计费时长)。
	    - 填入 `fee` (费用)。
	    - 订单状态 (`order_status`) 设为 `completed` (已完成)。
	- 提示用户“归还成功，租赁X小时，消耗电量Z%，费用Y元”。

**四、计费规则明确**

*   **费率：** 每小时 1.5 元。
*   **计费单位：** 不足一小时按一小时计算。

**五、数据实体与关键属性（初步设想，后续数据库设计会更详细）**
1. **用户 (User):**
    
    - 用户ID (User ID) - `user_id` (INT, Primary Key, Auto Increment)
    - 用户名 (Username) - `username` (VARCHAR, Unique, Not Null)
    - 密码 (Password - 存储哈希值) - `password_hash` (VARCHAR, Not Null)
    - 角色 (Role: SuperAdmin, Admin, User) - `role` (ENUM('superadmin', 'admin', 'user'), Not Null)
    - 账户状态 (Status: Active, Disabled) - `is_active` (BOOLEAN, Default TRUE, Not Null)
    - 创建时间 (Created At) - `created_at` (TIMESTAMP, Default CURRENT_TIMESTAMP, Not Null)
    - 最后活跃时间 (Last Login Time) - `last_login_time` (TIMESTAMP, Nullable)
2. **移动电源 (PowerBank):**
    
    - 电源ID/序列号 (PowerBank ID - 唯一标识) - `powerbank_id` (VARCHAR(50), Primary Key)
    - 型号 (Model) - `model` (VARCHAR(100), Not Null)
    - 设计容量 (Design Capacity mAh) - `initial_capacity_mah` (INT, Not Null)
    - 当前电量百分比 (Current Charge Percentage) - `current_charge_percentage` (INT, Not Null, Check 0-100, Default 100)
    - 状态 (Status: Available, Rented, LowBattery, Maintenance, Charging, Unavailable) - `status` (ENUM('available', 'rented', 'low_battery', 'maintenance', 'charging', 'unavailable'), Not Null, Default 'available')
    - 添加日期 (Added Date) - `added_date` (TIMESTAMP, Default CURRENT_TIMESTAMP, Not Null)
    - (可选) 位置描述 (Location Description) - `location_description` (VARCHAR(255))
    - 累计充电时间 (Total Charging Duration) - `total_charging_duration_minutes` (INT, Default 0, Not Null) - _目前仅作参考，手动更新或后续实现自动计算_
    - 累计租赁次数 (Total Rental Count) - `total_rental_count` (INT, Default 0, Not Null)
3. **租赁订单 (RentalOrder):**
    
    - 订单ID (Order ID) - `order_id` (INT, Primary Key, Auto Increment)
    - 用户ID (User ID - 关联用户) - `user_id` (INT, Not Null, Foreign Key references User(user_id))
    - 电源ID (PowerBank ID - 关联移动电源) - `powerbank_id` (VARCHAR(50), Not Null, Foreign Key references PowerBank(powerbank_id))
    - 租赁开始时间 (Rental Start Time) - `rental_start_time` (TIMESTAMP, Not Null)
    - 租赁开始时电源电量 (Rental Start Charge Percentage) - `rental_start_charge_percentage` (INT, Not Null, Check 0-100)
    - 归还时间 (Rental End Time) - `rental_end_time` (TIMESTAMP, Nullable)
    - 计费时长（小时）(Billed Hours) - `billed_hours` (INT, Nullable)
    - 费用 (Fee) - `fee` (DECIMAL(10,2), Nullable)
    - 订单状态 (Order Status: Active, Completed, Cancelled) - `order_status` (ENUM('active', 'completed', 'cancelled'), Not Null)

**六、非功能性需求**

1.  **用户界面 (UI)：**
    *   使用 Java Swing 构建图形用户界面。
    *   界面应直观、易于操作，对用户友好。
    *   不同角色的用户登录后应看到符合其权限的功能界面。
2.  **数据存储：**
    *   使用 MySQL 数据库。
3.  **安全性：**
    *   用户密码必须进行哈希加盐存储，不能明文存储。（**使用依赖**: `bcprov-jdk15on`）
    *   防止常见的安全漏洞，如SQL注入（通过预编译语句 PreparedStatement 实现）。
4.  **日志记录：**
    *   使用 SLF4J + Logback 记录关键操作日志、错误日志，便于追踪问题和审计。
    *   例如：用户登录/登出、注册、租赁/归还操作、管理员操作（增删改查用户/电源）、系统错误等。
5.  **容错性：**
    *   对用户的无效输入（如格式错误、空值）应有提示和处理。
    *   对预期可能发生的异常（如数据库连接失败、并发操作冲突等）应有捕获和适当处理，避免程序崩溃。
    *   例如，用户租赁一个已经被他人租用的电源时，应有友好提示。
6.  **技术栈约束：**
    *   JDK 24。
    *   使用 Maven 进行项目构建和依赖管理